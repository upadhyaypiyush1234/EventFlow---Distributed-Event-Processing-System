name: Deploy to Fly.io

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Deploy API
        run: flyctl deploy -c fly.toml --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      
      - name: Deploy Worker
        run: flyctl deploy -c fly.worker.toml --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      
      - name: Verify Deployment
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 10
          
          # Get API URL
          API_URL=$(flyctl info -a eventflow-api --json | jq -r '.Hostname')
          
          # Test health endpoint
          echo "Testing health endpoint at https://$API_URL/health"
          curl -f "https://$API_URL/health" || exit 1
          
          echo "‚úÖ Deployment successful!"
          echo "üåê API URL: https://$API_URL"
          echo "üìö Docs: https://$API_URL/docs"
